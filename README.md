# Prometheus and Loki Monitoring Mixin for Kubernetes Events

A set of Grafana dashboards and Loki rules for Kubernetes Events. It requires Loki and Alloy

## Configuring Loki and Alloy

The following [blog post gives an example on how to configure Loki and Alloy to work with this mixin](https://hodovi.cc/blog/kubernetes-events-monitoring-with-loki-alloy-and-grafana/).

## How to use the mixin

This mixin is designed to be vendored into the repo with your infrastructure config.
To do this, use [jsonnet-bundler](https://github.com/jsonnet-bundler/jsonnet-bundler):

You then have three options for deploying your dashboards

1. Generate the config files and deploy them yourself
2. Use jsonnet to deploy this mixin along with Prometheus and Grafana
3. Use prometheus-operator to deploy this mixin

Or import the dashboard using json in `./dashboards_out`, alternatively import them from the `Grafana.com` dashboard page.

## Generate config files

You can manually generate the alerts, dashboards and rules files, but first you
must install some tools:

```sh
go get github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb
brew install jsonnet
```

Then, grab the mixin and its dependencies:

```sh
git clone https://github.com/adinhodovic/kubernetes-events-mixin
cd kubernetes-events
jb install
```

Finally, build the mixin:

```sh
make prometheus_rules.yaml
make dashboards_out
```

The `prometheus_rules.yaml` file then need to passed
to your Loki server, and the files in `dashboards_out` need to be imported
into you Grafana server. The exact details will depending on how you deploy your
monitoring stack.

## Loki Rules

Note: the rules generated by the mixin are designed to be used with Loki. This means that a `remote_write` configuration is required in your Loki setup and that Loki should load the rules, not Prometheus. The rules generate Prometheus metrics from the Loki logs, which can then be queried in Grafana.

Read: [Loki Remote Write](https://grafana.com/docs/loki/latest/alert/#remote-write)
